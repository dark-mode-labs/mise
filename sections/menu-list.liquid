{% assign s = section.settings %}
{% assign menu = shop.menu_data[s.menu] %}

{% capture section_spacing_style %}
  {% if s.padding_vertical == 'custom' %}
    --space-py: {{ s.padding_vertical_custom }}px;
  {% endif %}
  {% if s.padding_horizontal == 'custom' %}
     --space-px: {{ s.padding_horizontal_custom }}px;
  {% endif %}
  {% if s.nav_layout == 'horizontal' %}top: {{ s.nav_sticky_offset }}px;{% endif %}
{% endcapture %}

{% capture section_spacing_class %}
  section-py-{{ s.padding_vertical }}
  section-px-{{ s.padding_horizontal }}
{% endcapture %}

{% assign animation_class = '' %}
{% if s.enable_animation %}
  {% assign animation_class = 'stagger-load' %}
{% endif %}

{% assign column_class = 'menu-cols-' | append: s.column_preset | replace: ':', '-' %}
{% assign grid_gap_x_class = 'menu-gap-x-' | append: s.grid_gap_x %}
{% assign grid_gap_y_class = 'menu-gap-y-' | append: s.grid_gap_y %}
{% assign card_padding_class = 'menu-card-p-' | append: s.card_padding %}
{% assign list_padding_class = 'menu-list-row-' | append: s.list_row_padding %}
{% assign list_image_class = 'menu-list-img-' | append: s.list_image_size %}

{% assign grid_class = 'grid'
  | append: ' '
  | append: column_class
  | append: ' '
  | append: grid_gap_x_class
  | append: ' '
  | append: grid_gap_y_class
%}

{% assign main_flex_direction = 'flex-col lg:flex-row' %}
{% assign nav_container_class = 'hidden lg:block w-64 flex-shrink-0 sticky self-start z-floating top-32' %}
{% assign nav_wrapper_class = 'flex flex-col gap-2 border-l-2 border-body/10 pl-4 overflow-y-auto no-scrollbar' %}
{% assign link_base_class = 'block border-l-2 border-transparent -ml-[18px] pl-[14px] [&.is-active]:border-body [&.is-active]:pl-4' %}
{% assign sublink_base_class = 'block' %}

{% if s.nav_layout == 'horizontal' %}
  {% capture sticky_style %}top: {{ s.nav_sticky_offset }}px;{% endcapture %}
  {% assign main_flex_direction = 'flex-col' %}
  {% assign nav_container_class = 'w-full sticky z-floating bg-[var(--color-bg)] border-b border-body/10 mb-8 transition-[top] duration-200' %}
  {% assign nav_wrapper_class = 'flex flex-row items-center gap-6 overflow-x-auto no-scrollbar py-3 px-1' %}
  {% assign link_base_class = 'whitespace-nowrap border-b-2 border-transparent pb-2 transition-all duration-300 [&.is-active]:border-body [&.is-active]:opacity-100 [&.is-active]:font-bold' %}
  {% assign sublink_base_class = 'hidden' %}
{% endif %}

<section
  class="color-{{ s.color_scheme }}"
  data-spy-scope
  data-filter-scope
>
  <div
    class="bg-body width-{{ s.width_scheme }} limit-width {{ section_spacing_class }}"
    style="{{ section_spacing_style }}"
  >
    <div class="text-center mx-auto mb-16 animate-fade-up">
      {% if s.heading != blank %}
        {% render 'typography', text: s.heading, tag: 'h2', size: 'display', color: 'var(--color-text)' %}
      {% endif %}

      {% if s.subtext != blank %}
        <div class="text-secondary mt-4">
          {% render 'typography', text: s.subtext, tag: 'div', size: 'body', color: 'var(--color-text-secondary)' %}
        </div>
      {% endif %}
    </div>

    <div class="flex {{ main_flex_direction }} relative">
      {% assign all_categories = menu.categories | map_values | sort: 'display_order' %}
      {% if s.display_scope == 'full_menu' %}
        {% assign root_categories = all_categories | where: 'parent_uuid', null %}
      {% elsif s.display_scope == 'category' %}
        {% assign root_categories = menu.categories[s.category] | sort %}
      {% endif %}
      {% if s.show_nav and root_categories != blank %}
        <div
          class="{{ nav_container_class }}"
          style="{{ sticky_style }}"
          {% if s.enable_filtering %}
            data-behavior="menu-filter"
          {% endif %}
        >
          <div class="{% if s.nav_layout == 'horizontal' %}flex items-center justify-between gap-4 max-w-none px-4{% else %}flex flex-col gap-6{% endif %}">
            {% if s.enable_filtering %}
              <div class="relative {% if s.nav_layout == 'horizontal' %}w-48 hidden md:block flex-shrink-0 order-2 ml-auto{% else %}w-[85%] order-1{% endif %}">
                <input
                  type="text"
                  placeholder="Search menu..."
                  class="w-full bg-transparent border border-std rounded-full px-4 py-2 text-sm focus:border-body focus:outline-none transition-colors placeholder:text-secondary"
                  data-filter-search
                >
                {% render 'icon',
                  name: 'search',
                  class: 'absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-secondary pointer-events-none'
                %}
              </div>
            {% endif %}
            {% if s.enable_filtering and menu.dietary_flags.size > 0 %}
              <div
                class="{% if s.nav_layout == 'horizontal' %}flex gap-1 flex-shrink-0 order-3 border-l border-std pl-4 hidden md:flex{% else %}flex flex-wrap gap-2 order-2{% endif %}"
                data-filter-tags
              >
                {% for tag in menu.dietary_flags %}
                  {% assign tag_name = tag.name | downcase %}
                  <button
                    type="button"
                    data-filter-tag="{{ tag_name }}"
                    title="Filter by {{ tag.name }}"
                    class="{% if s.nav_layout == 'horizontal' %}w-6 h-6 flex items-center justify-center border border-std rounded-full text-[10px] font-bold uppercase text-secondary hover:text-body hover:border-body{% else %}px-2 py-1 border border-std rounded text-[10px] uppercase tracking-wider text-secondary hover:text-body hover:border-body{% endif %} transition-all [&.is-active]:bg-[var(--color-text)] [&.is-active]:text-[var(--color-bg)] [&.is-active]:opacity-100"
                  >
                    {% render 'icon', name: tag_name, class: 'w-4 h-4' %}
                  </button>
                {% endfor %}
              </div>
            {% endif %}

            <nav
              data-behavior="menu-spy"
              class="{{ nav_wrapper_class }} flex-grow min-w-0 {% if s.nav_layout == 'vertical' %}order-3{% else %}order-1{% endif %}"
            >
              {% for parent in root_categories %}
                {% render 'menu-nav-recursive',
                  category: parent,
                  all_categories: all_categories,
                  depth: 0,
                  nav_layout: s.nav_layout,
                  link_base_class: link_base_class,
                  sublink_base_class: sublink_base_class
                %}
              {% endfor %}
            </nav>
          </div>
        </div>
      {% endif %}

      <div class="flex-grow flex flex-col gap-20" data-filter-container>
        {% for parent in root_categories %}
          {% render 'menu-category-recursive',
            category: parent,
            all_categories: all_categories,
            depth: 0,
            grid_class: grid_class,
            animation_class: animation_class,
            spy_target: parent.uuid,
            card_padding_class: card_padding_class,
            list_padding_class: list_padding_class,
            list_image_class: list_image_class,
            layout_style: s.layout_style,
            aspect_ratio: s.aspect_ratio,
            card_image_position: s.image_position,
            nav_layout: s.nav_layout
          %}
        {% endfor %}
      </div>
    </div>

    <div id="filter-empty-state" class="hidden w-full py-20 text-center opacity-50">
      <p class="text-xl font-heading font-bold">No items found matching your filters.</p>
      <button type="button" data-action="clear-filters" class="mt-4 underline text-sm hover:opacity-100">
        Clear Filters
      </button>
    </div>

    {% if menu.disclaimers.size > 0 %}
      <div class="w-full text-center mt-20 flex flex-col gap-3 opacity-60 text-xs uppercase tracking-widest mx-auto border-t border-body/10 pt-8">
        {% for disclaimer in menu.disclaimers %}
          <p>{{ disclaimer.text }}</p>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Menu View",
  "settings": [
    { "type": "header", "content": "Data Source" },
    { "type": "collection", "id": "menu", "label": "Select Menu" },
    {
      "type": "select",
      "id": "display_scope",
      "label": "Display Scope",
      "options": [
        { "value": "full_menu", "label": "Full Menu (All Categories)" },
        { "value": "category", "label": "Specific Category Only" }
      ],
      "default": "full_menu"
    },
    {
      "type": "collection",
      "id": "category",
      "label": "Category Name",
      "info": "Select category to display.",
      "conditional": "setting.display_scope == 'category'"
    },

    { "type": "header", "content": "Filtering & Search" },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable Filtering Bar",
      "default": true
    },

    { "type": "header", "content": "Navigation", "conditional": "setting.display_scope == 'full_menu'" },
    {
      "type": "checkbox",
      "id": "show_nav",
      "label": "Show Sticky Navigation",
      "default": true,
      "conditional": "setting.display_scope == 'full_menu'"
    },
    {
      "type": "select",
      "id": "nav_layout",
      "label": "Navigation Layout",
      "options": [
        { "value": "vertical", "label": "Vertical Sidebar (Desktop Only)" },
        { "value": "horizontal", "label": "Horizontal Top Bar" }
      ],
      "default": "vertical",
      "info": "Horizontal layout works best for menus with many top-level categories.",
      "conditional": "setting.show_nav"
    },
    {
      "type": "range",
      "id": "nav_sticky_offset",
      "label": "Sticky Top Offset (Horizontal Nav Layout)",
      "info": "Adjust this to clear your site header if the menu is being covered.",
      "min": 0,
      "max": 160,
      "step": 4,
      "default": 80,
      "unit": "px",
      "conditional": "setting.show_nav and setting.nav_layout == 'horizontal'"
    },

    { "type": "header", "content": "Layout" },
    {
      "type": "select",
      "id": "layout_style",
      "label": "Layout Style",
      "options": [
        { "value": "list", "label": "List" },
        { "value": "card-standard", "label": "Standard Card" },
        { "value": "card-compact", "label": "Compact Card" }
      ],
      "default": "list"
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Card Image Ratio",
      "options": [
        { "value": "square", "label": "Square (1:1)" },
        { "value": "landscape", "label": "Landscape (4:3)" },
        { "value": "portrait", "label": "Portrait (3:4)" }
      ],
      "default": "landscape",
      "conditional": "setting.layout_style != 'list'"
    },
    {
      "type": "select",
      "id": "card_image_position",
      "label": "Card Image Position",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left",
      "conditional": "setting.layout_style == 'card-compact'"
    },
    {
      "type": "select",
      "id": "column_preset",
      "label": "Column Presets",
      "options": [
        { "value": "1:1:1", "label": "1 (Small), 1 (Medium), 1 (Large)" },
        { "value": "1:2:2", "label": "1 (Small), 2 (Medium), 2 (Large)" },
        { "value": "1:2:3", "label": "1 (Small), 2 (Medium), 3 (Large)" }
      ],
      "default": "1:2:3"
    },

    { "type": "header", "content": "Layout Tuning" },
    {
      "type": "select",
      "id": "grid_gap_x",
      "label": "Horizontal Grid Gap",
      "options": [
        { "value": "tight", "label": "Tight" },
        { "value": "normal", "label": "Normal" },
        { "value": "relaxed", "label": "Relaxed" },
        { "value": "loose", "label": "Loose" }
      ],
      "default": "relaxed"
    },
    {
      "type": "select",
      "id": "grid_gap_y",
      "label": "Vertical Grid Gap",
      "options": [
        { "value": "tight", "label": "Tight" },
        { "value": "normal", "label": "Normal" },
        { "value": "relaxed", "label": "Relaxed" },
        { "value": "loose", "label": "Loose" }
      ],
      "default": "normal"
    },
    {
      "type": "select",
      "id": "card_padding",
      "label": "Card Internal Padding",
      "options": [
        { "value": "tight", "label": "Tight" },
        { "value": "compact", "label": "Compact" },
        { "value": "normal", "label": "Normal" },
        { "value": "relaxed", "label": "Relaxed" },
        { "value": "loose", "label": "Loose" }
      ],
      "default": "normal",
      "conditional": "setting.layout_style != 'list'"
    },
    {
      "type": "select",
      "id": "list_row_padding",
      "label": "List View Row Height",
      "options": [
        { "value": "tight", "label": "Tight" },
        { "value": "normal", "label": "Normal" },
        { "value": "relaxed", "label": "Relaxed" },
        { "value": "loose", "label": "Loose" }
      ],
      "default": "normal",
      "conditional": "setting.layout_style == 'list'"
    },
    {
      "type": "select",
      "id": "list_image_size",
      "label": "List View Image Size",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium",
      "conditional": "setting.layout_style == 'list'"
    },

    { "type": "header", "content": "Layout" },
    {
      "type": "width_scheme",
      "id": "width_scheme",
      "label": "Max Content Width",
      "default": "standard"
    },

    { "type": "header", "content": "Content" },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "info": "Defaults to Menu Name or override",
      "default": "{{ menu.name }}"
    },
    { "type": "textarea", "id": "subtext", "label": "Description" },

    { "type": "header", "content": "Spacing" },
    {
      "type": "select",
      "id": "padding_vertical",
      "label": "Vertical Padding",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "xs", "label": "Extra Small" },
        { "value": "sm", "label": "Small" },
        { "value": "md", "label": "Medium" },
        { "value": "lg", "label": "Large" },
        { "value": "xl", "label": "Extra Large" },
        { "value": "custom", "label": "Custom" }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "padding_vertical_custom",
      "label": "Custom Vertical Padding",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 80,
      "unit": "px",
      "conditional": "setting.padding_vertical == 'custom'"
    },
    {
      "type": "select",
      "id": "padding_horizontal",
      "label": "Horizontal Padding",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "xs", "label": "Extra Small" },
        { "value": "sm", "label": "Small" },
        { "value": "md", "label": "Medium" },
        { "value": "lg", "label": "Large" },
        { "value": "xl", "label": "Extra Large" },
        { "value": "custom", "label": "Custom" }
      ],
      "default": "xs"
    },
    {
      "type": "range",
      "id": "padding_horizontal_custom",
      "label": "Custom Horizontal Padding",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0,
      "unit": "px",
      "conditional": "setting.padding_horizontal == 'custom'"
    },

    { "type": "header", "content": "Theme" },
    { "type": "checkbox", "id": "enable_animation", "label": "Enable Entry Animation", "default": true },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color Palette", "default": "default" }
  ],
  "presets": [{ "name": "Menu View" }]
}
{% endschema %}
