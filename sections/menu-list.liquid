{% assign s = section.settings %}
{% assign menu = shop.menu_data[s.menu] %}

{% assign animation_class = '' %}
{% if s.enable_animation %}
  {% assign animation_class = 'stagger-load' %}
{% endif %}

{% capture column_class %}
  {% case s.columns %}
    {% when 2 %}grid-cols-1 md:grid-cols-2
    {% when 3 %}grid-cols-1 md:grid-cols-3
    {% else %}grid-cols-1
  {% endcase %}
{% endcapture %}

{% assign grid_class = 'grid'
  | append: ' '
  | append: column_class
  | append: ' '
  | append: s.grid_gap_x
  | append: ' '
  | append: s.grid_gap_y
%}

<section
  class="w-full color-{{ s.color_scheme }}"
  style="padding-top: {{ s.padding_top }}px; padding-bottom: {{ s.padding_bottom }}px;"
>
  <div class="wrapper">
    <div class="text-center max-w-3xl mx-auto mb-16 animate-fade-up">
      {% if s.heading != blank %}
        {% render 'typography', text: s.heading, tag: 'h2', size: 'display', color: 'var(--color-text)' %}
      {% else %}
        {% render 'typography', text: menu.name, tag: 'h2', size: 'display', color: 'var(--color-text)' %}
      {% endif %}

      {% if s.subtext != blank %}
        <div class="opacity-80 mt-4">
          {% render 'typography', text: s.subtext, tag: 'div', size: 'body', color: 'var(--color-text)' %}
        </div>
      {% endif %}
    </div>

    <div class="flex flex-col lg:flex-row gap-12">
      {% if s.display_scope == 'full_menu' %}
        {% assign all_categories = menu.categories | map_values | sort: 'display_order' %}
        {% assign root_categories = all_categories | where: 'parent_uuid', null %}

        {% if s.show_nav and root_categories.size > 1 %}
          <div class="hidden lg:block w-64 flex-shrink-0">
            <nav class="sticky top-32 flex flex-col gap-2 border-l-2 border-[var(--color-text)]/10 pl-4">
              {% for parent in root_categories %}
                <a
                  href="#cat-{{ parent.uuid }}"
                  class="text-sm font-bold opacity-50 hover:opacity-100 transition-opacity uppercase tracking-wider py-1"
                >
                  {{ parent.name }}
                </a>
                {% assign nav_children = all_categories | where: 'parent_uuid', parent.uuid %}
                {% if nav_children.size > 0 %}
                  <div class="pl-4 flex flex-col gap-1 mt-1 mb-2 border-l border-[var(--color-text)]/5">
                    {% for child in nav_children %}
                      <a href="#cat-{{ child.uuid }}" class="text-xs opacity-40 hover:opacity-80 uppercase">
                        {{- child.name -}}
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}
              {% endfor %}
            </nav>
          </div>
        {% endif %}

        <div class="flex-grow flex flex-col gap-20">
          {% for parent in root_categories %}
            <div id="cat-{{ parent.uuid }}" class="scroll-mt-32 menu-category-group">
              <div class="flex items-end justify-between border-b-2 border-[var(--color-text)] mb-8 pb-2">
                <h3 class="font-heading text-3xl font-bold uppercase tracking-wide">{{ parent.name }}</h3>
              </div>

              {% comment %}
                Item doesnt have a display_order attr as yet, im thinking it makes sense to have it there but how much overhead will it be
                 {% assign parent_items = parent.items | sort: 'display_order' %}
              {% endcomment %}
              {% assign parent_items = parent.items %}
              {% if parent_items.size > 0 %}
                <div class="{{ grid_class }} mb-12 {{ animation_class }}">
                  {% for item in parent_items %}
                    {% if s.layout_style contains 'card-' %}
                      {% assign card_style = s.layout_style | replace: 'card-', '' %}
                      {% render 'menu-item-card',
                        item: item,
                        ratio: s.aspect_ratio,
                        style: card_style,
                        padding_class: s.card_padding
                      %}
                    {% else %}
                      {% render 'menu-item-list', item: item, padding_class: s.list_row_padding %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}

              {% assign children = all_categories | where: 'parent_uuid', parent.uuid %}
              {% for child in children %}
                <div class="mb-12 pl-0 md:pl-4">
                  <h4 class="font-heading text-xl font-bold mb-6 opacity-80">{{ child.name }}</h4>
                  <div class="{{ grid_class }} {{ animation_class }}">
                    {% comment %}
                      Item doesnt have a display_order attr as yet, im thinking it makes sense to have it there but how much overhead will it be
                      {% assign child_items = child.items | sort: 'display_order' %}
                    {% endcomment %}
                    {% assign child_items = child.items %}
                    {% for item in child_items %}
                      {% if s.layout_style contains 'card-' %}
                        {% assign card_style = s.layout_style | replace: 'card-', '' %}
                        {% render 'menu-item-card',
                          item: item,
                          ratio: s.aspect_ratio,
                          style: card_style,
                          padding_class: s.card_padding
                        %}
                      {% else %}
                        {% render 'menu-item-list', item: item, padding_class: s.list_row_padding %}
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>

      {% elsif s.display_scope == 'category' %}
        {% assign target_category = menu.categories | map_values | where: 'name', s.category_filter | first %}

        <div class="w-full flex-grow">
          {% if target_category %}
            <div class="{{ grid_class }} {{ animation_class }}">
              {% assign sorted_items = target_category.items | sort: 'display_order' %}
              {% for item in sorted_items %}
                {% if s.layout_style contains 'card-' %}
                  {% assign card_style = s.layout_style | replace: 'card-', '' %}
                  {% render 'menu-item-card',
                    item: item,
                    ratio: s.aspect_ratio,
                    style: card_style,
                    padding_class: s.card_padding
                  %}
                {% else %}
                  {% render 'menu-item-list', item: item, padding_class: s.list_row_padding %}
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center opacity-50 py-12">
              Category "{{ s.category_filter }}" not found in menu "{{ menu.name }}".
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    {% if menu.disclaimers.size > 0 %}
      <div class="w-full text-center mt-20 flex flex-col gap-3 opacity-60 text-xs uppercase tracking-widest max-w-4xl mx-auto border-t border-[var(--color-text)]/10 pt-8">
        {% for disclaimer in menu.disclaimers %}
          <p>{{ disclaimer.text }}</p>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "Menu View",
  "settings": [
    { "type": "header", "content": "Data Source" },
    { "type": "collection", "id": "menu", "label": "Select Menu" },
    {
      "type": "select",
      "id": "display_scope",
      "label": "Display Scope",
      "options": [
        { "value": "full_menu", "label": "Full Menu (All Categories)" },
        { "value": "category", "label": "Specific Category Only" }
      ],
      "default": "full_menu"
    },
    {
      "type": "text",
      "id": "category_filter",
      "label": "Category Name",
      "info": "Exact name of the category (e.g. 'Starters'). Used if Scope is Category."
    },

    { "type": "header", "content": "Layout" },
    { "type": "header", "content": "Style" },
    {
      "type": "select",
      "id": "layout_style",
      "label": "Layout Style",
      "options": [
        { "value": "list", "label": "List" },
        { "value": "card-standard", "label": "Standard Card" },
        { "value": "card-compact", "label": "Compact Card" }
      ],
      "default": "list"
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Card Image Ratio",
      "options": [
        { "value": "square", "label": "Square (1:1)" },
        { "value": "landscape", "label": "Landscape (4:3)" },
        { "value": "portrait", "label": "Portrait (3:4)" }
      ],
      "default": "landscape"
    },
    {
      "type": "checkbox",
      "id": "show_nav",
      "label": "Show Sticky Navigation",
      "default": true,
      "info": "Only active in Full Menu mode."
    },
    {
      "type": "range",
      "id": "columns",
      "label": "Columns per Category",
      "min": 1,
      "max": 3,
      "default": 1
    },

    { "type": "header", "content": "Layout Tuning" },
    {
      "type": "select",
      "id": "grid_gap_x",
      "label": "Horizontal Grid Gap",
      "options": [
        { "value": "gap-x-4", "label": "Tight (1rem)" },
        { "value": "gap-x-8", "label": "Normal (2rem)" },
        { "value": "gap-x-12", "label": "Relaxed (3rem)" },
        { "value": "gap-x-16", "label": "Loose (4rem)" }
      ],
      "default": "gap-x-12"
    },
    {
      "type": "select",
      "id": "grid_gap_y",
      "label": "Vertical Grid Gap",
      "options": [
        { "value": "gap-y-4", "label": "Tight (1rem)" },
        { "value": "gap-y-8", "label": "Normal (2rem)" },
        { "value": "gap-y-12", "label": "Relaxed (3rem)" },
        { "value": "gap-y-16", "label": "Loose (4rem)" }
      ],
      "default": "gap-y-8"
    },
    {
      "type": "select",
      "id": "card_padding",
      "label": "Card Internal Padding",
      "options": [
        { "value": "p-3", "label": "Tight" },
        { "value": "p-4", "label": "Compact" },
        { "value": "p-5", "label": "Normal" },
        { "value": "p-6", "label": "Relaxed" },
        { "value": "p-8", "label": "Loose" }
      ],
      "default": "p-5"
    },
    {
      "type": "select",
      "id": "list_row_padding",
      "label": "List View Row Height",
      "options": [
        { "value": "py-2", "label": "Tight" },
        { "value": "py-4", "label": "Normal" },
        { "value": "py-6", "label": "Relaxed" },
        { "value": "py-8", "label": "Loose" }
      ],
      "default": "py-4"
    },

    { "type": "header", "content": "Content" },
    { "type": "text", "id": "heading", "label": "Section Heading", "info": "Overrides Menu Name if set" },
    { "type": "textarea", "id": "subtext", "label": "Description" },

    { "type": "header", "content": "Spacing" },
    { "type": "range", "id": "padding_top", "label": "Top Padding", "min": 0, "max": 160, "step": 4, "default": 96 },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom Padding",
      "min": 0,
      "max": 160,
      "step": 4,
      "default": 96
    },

    { "type": "header", "content": "Theme" },
    { "type": "checkbox", "id": "enable_animation", "label": "Enable Entry Animation", "default": true },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color Palette", "default": "scheme-1" }
  ],
  "presets": [{ "name": "Menu View" }]
}
{% endschema %}
